<!-- èƒŒæ™¯å›¾ -->
<image class="global-bg" src="../../images/background.png" mode="aspectFill"/>

<!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
<view class="nav-bar">
  <view class="nav-left">
    <view class="nav-back" bindtap="navigateBack">
      <text class="back-icon">â€¹</text>
    </view>
  </view>
  <view class="nav-title">å›¢è¯¾æ•°æ®ç»Ÿè®¡</view>
  <view class="nav-right"></view>
</view>

<!-- é¡µé¢å†…å®¹ -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- é€‰é¡¹å¡å¸ƒå±€ -->
  <view wx:else class="tab-layout">
    <!-- é€‰é¡¹å¡å¤´éƒ¨ -->
    <view class="tab-header">
      <view class="tab-item {{currentTab === 'upcoming' ? 'active' : ''}}" 
            bindtap="switchTab" 
            data-tab="upcoming">
        <text class="tab-text">æœªå‘ç”Ÿè¯¾ç¨‹</text>
        <text class="tab-count">({{upcomingCourses.length}}èŠ‚)</text>
        <text class="tab-desc">å·²é¢„çº¦ + ç­‰ä½å­¦å‘˜</text>
      </view>
      <view class="tab-item {{currentTab === 'completed' ? 'active' : ''}}" 
            bindtap="switchTab" 
            data-tab="completed">
        <text class="tab-text">å·²å®Œæˆè¯¾ç¨‹</text>
        <text class="tab-count" wx:if="{{completedLoaded}}">({{completedCourses.length}}èŠ‚)</text>
        <text class="tab-count" wx:else>(ç‚¹å‡»åŠ è½½)</text>
        <text class="tab-desc">æ‰€æœ‰çº¦è¯¾å­¦å‘˜</text>
      </view>
    </view>

    <!-- æœªå‘ç”Ÿè¯¾ç¨‹å†…å®¹ -->
    <view wx:if="{{currentTab === 'upcoming'}}" class="tab-content">
      <view wx:if="{{upcomingCourses.length === 0}}" class="empty-state">
        <view class="empty-icon">ğŸ“…</view>
        <view class="empty-text">æš‚æ— æœªå‘ç”Ÿçš„è¯¾ç¨‹</view>
      </view>

      <view wx:else class="course-list">
        <view class="course-item" wx:for="{{upcomingCourses}}" wx:key="id" bindtap="toggleCourseDetail" data-index="{{index}}">
          <!-- è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ -->
          <view class="course-info">
            <view class="course-header">
              <view class="course-title">{{item.courseName}}</view>
              <view class="booking-count upcoming">
                <text class="count-number">{{item.bookingCount}}</text>
                <text class="count-label">äººé¢„çº¦</text>
              </view>
            </view>
            
            <view class="course-details">
              <view class="detail-item">
                <text class="detail-icon">ğŸ“…</text>
                <text class="detail-text">{{item.dateStr}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-icon">ğŸ•</text>
                <text class="detail-text">{{item.timeStr}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-icon">è€å¸ˆ:</text>
                <text class="detail-text">{{item.teacherName}}</text>
              </view>
            </view>

            <!-- å±•å¼€/æ”¶èµ·å›¾æ ‡ -->
            <view class="expand-icon">
              <text class="expand-text">{{item.showDetail ? 'æ”¶èµ·' : 'æŸ¥çœ‹é¢„çº¦'}}</text>
              <text class="expand-arrow">{{item.showDetail ? 'â–²' : 'â–¼'}}</text>
            </view>
          </view>

          <!-- é¢„çº¦å­¦å‘˜åˆ—è¡¨ -->
          <view wx:if="{{item.showDetail}}" class="booking-list">
            <view wx:if="{{item.bookings.length === 0}}" class="no-bookings">
              <text class="no-bookings-text">æš‚æ— é¢„çº¦</text>
            </view>
            
            <view wx:else class="booking-students">
              <view class="students-header">é¢„çº¦å­¦å‘˜åˆ—è¡¨ï¼š</view>
              <view class="student-item" wx:for="{{item.bookings}}" wx:for-item="booking" wx:key="id">
                <view class="student-info">
                  <view class="student-name">{{booking.userName}}</view>
                  <view class="student-phone">{{booking.userPhone}}</view>
                </view>
                <view class="booking-status {{booking.status}}">
                  {{booking.status === 'booked' ? 'å·²é¢„çº¦' : booking.status === 'waitlist' ? 'ç­‰ä½ä¸­' : booking.status}}
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å·²å®Œæˆè¯¾ç¨‹å†…å®¹ -->
    <view wx:if="{{currentTab === 'completed'}}" class="tab-content">
      <!-- æœªåŠ è½½æ—¶æ˜¾ç¤ºåŠ è½½æŒ‰é’® -->
      <view wx:if="{{!completedLoaded}}" class="load-completed-section">
        <view class="load-tip">
          <view class="tip-icon">ğŸ’¡</view>
          <view class="tip-text">å·²å®Œæˆè¯¾ç¨‹æ•°æ®è¾ƒå¤šï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åŠ è½½</view>
        </view>
        <button class="load-completed-btn {{completedLoading ? 'loading' : ''}}" 
                bindtap="loadCompletedCourses" 
                disabled="{{completedLoading}}">
          <text wx:if="{{completedLoading}}">åŠ è½½ä¸­...</text>
          <text wx:else>åŠ è½½å·²å®Œæˆè¯¾ç¨‹</text>
        </button>
      </view>

      <!-- å·²åŠ è½½ä½†æ²¡æœ‰æ•°æ® -->
      <view wx:elif="{{completedCourses.length === 0}}" class="empty-state">
        <view class="empty-icon">âœ…</view>
        <view class="empty-text">æš‚æ— å·²å®Œæˆçš„è¯¾ç¨‹</view>
      </view>

      <!-- è¯¾ç¨‹åˆ—è¡¨ -->
      <view wx:else class="course-list">
        <view class="course-item" wx:for="{{completedCourses}}" wx:key="id" bindtap="toggleCourseDetail" data-index="{{index}}">
          <!-- è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ -->
          <view class="course-info">
            <view class="course-header">
              <view class="course-title">{{item.courseName}}</view>
              <view class="booking-count completed">
                <text class="count-number">{{item.completedBookings}}</text>
                <text class="count-label">äººå®Œæˆ</text>
              </view>
            </view>
            
            <view class="course-details">
              <view class="detail-item">
                <text class="detail-icon">ğŸ“…</text>
                <text class="detail-text">{{item.dateStr}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-icon">ğŸ•</text>
                <text class="detail-text">{{item.timeStr}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-icon">è€å¸ˆ:</text>
                <text class="detail-text">{{item.teacherName}}</text>
              </view>
            </view>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <view class="stats-info">
              <text class="stat-item total">æ€»è®¡: {{item.totalBookings}}</text>
              <text class="stat-item completed">å®Œæˆ: {{item.completedBookings}}</text>
              <text class="stat-item cancelled">å–æ¶ˆ: {{item.cancelledBookings}}</text>
              <text class="stat-item failed">å¤±è´¥: {{item.failedBookings}}</text>
            </view>

            <!-- å±•å¼€/æ”¶èµ·å›¾æ ‡ -->
            <view class="expand-icon">
              <text class="expand-text">{{item.showDetail ? 'æ”¶èµ·' : 'æŸ¥çœ‹è¯¦æƒ…'}}</text>
              <text class="expand-arrow">{{item.showDetail ? 'â–²' : 'â–¼'}}</text>
            </view>
          </view>

          <!-- é¢„çº¦å­¦å‘˜åˆ—è¡¨ -->
          <view wx:if="{{item.showDetail}}" class="booking-list">
            <view wx:if="{{item.bookings.length === 0}}" class="no-bookings">
              <text class="no-bookings-text">æš‚æ— è®°å½•</text>
            </view>
            
            <view wx:else class="booking-students">
              <view class="students-header">çº¦è¯¾å­¦å‘˜åˆ—è¡¨ï¼š</view>
              <view class="student-item" wx:for="{{item.bookings}}" wx:for-item="booking" wx:key="id">
                <view class="student-info">
                  <view class="student-name">{{booking.userName}}</view>
                  <view class="student-phone">{{booking.userPhone}}</view>
                  <view wx:if="{{booking.cancelTime}}" class="cancel-time">
                    å–æ¶ˆæ—¶é—´: {{booking.cancelTime}}
                  </view>
                </view>
                <view class="booking-status {{booking.status}}">
                  {{booking.status === 'done' ? 'å·²å®Œæˆ' : booking.status === 'cancelled' ? 'å·²å–æ¶ˆ' : booking.status === 'fail' ? 'ç­‰ä½å¤±è´¥' : booking.status}}
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
