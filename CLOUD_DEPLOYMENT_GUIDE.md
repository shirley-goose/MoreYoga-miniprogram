# å¢¨ç‘œä¼½çº¦è¯¾ç³»ç»Ÿ - äº‘å¼€å‘éƒ¨ç½²æŒ‡å—

## ğŸš€ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—å°†æŒ‡å¯¼æ‚¨å®Œæˆå¢¨ç‘œä¼½çº¦è¯¾ç³»ç»Ÿçš„å¾®ä¿¡äº‘å¼€å‘ç¯å¢ƒè®¾ç½®å’Œäº‘å‡½æ•°éƒ¨ç½²ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

- å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
- å·²ç”³è¯·çš„å¾®ä¿¡å°ç¨‹åºè´¦å·
- å¼€é€šå¾®ä¿¡äº‘å¼€å‘æœåŠ¡

## ğŸ› ï¸ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå¼€é€šäº‘å¼€å‘

1. **æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·**
   - å¯¼å…¥é¡¹ç›®ï¼šé€‰æ‹© `miniprogram` ç›®å½•
   - å¡«å†™ AppIDï¼ˆä½¿ç”¨æ‚¨çš„å°ç¨‹åº AppIDï¼‰

2. **å¼€é€šäº‘å¼€å‘**
   - ç‚¹å‡»å·¥å…·æ ä¸­çš„"äº‘å¼€å‘"
   - ç‚¹å‡»"å¼€é€š"
   - é€‰æ‹©ç¯å¢ƒåç§°ï¼š`yoga-booking-system`ï¼ˆæˆ–è‡ªå®šä¹‰åç§°ï¼‰
   - é€‰æ‹©å¥—é¤ï¼šå»ºè®®é€‰æ‹©"å…è´¹å¥—é¤"è¿›è¡Œæµ‹è¯•

3. **è·å–äº‘ç¯å¢ƒID**
   - å¼€é€šåï¼Œè®°å½•æ‚¨çš„äº‘ç¯å¢ƒID
   - æ›´æ–° `miniprogram/app.js` ä¸­çš„ç¯å¢ƒIDï¼š
   ```javascript
   wx.cloud.init({
     env: 'your-cloud-env-id', // æ›¿æ¢ä¸ºæ‚¨çš„äº‘ç¯å¢ƒID
     traceUser: true
   });
   ```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ•°æ®åº“é›†åˆ

åœ¨äº‘å¼€å‘æ§åˆ¶å°çš„æ•°æ®åº“ä¸­åˆ›å»ºä»¥ä¸‹é›†åˆï¼š

#### 2.1 ç”¨æˆ·é›†åˆ (users)
```json
{
  "_id": "æ–‡æ¡£ID",
  "openid": "ç”¨æˆ·openid",
  "nickName": "ç”¨æˆ·æ˜µç§°",
  "avatarUrl": "å¤´åƒåœ°å€",
  "phone": "æ‰‹æœºå·",
  "groupCredits": 0,
  "termCredits": 0,
  "totalClasses": 0,
  "createTime": "2025-01-01T00:00:00.000Z",
  "updateTime": "2025-01-01T00:00:00.000Z"
}
```

#### 2.2 è¯¾ç¨‹é›†åˆ (courses)
```json
{
  "_id": "è¯¾ç¨‹ID",
  "title": "è¯¾ç¨‹åç§°",
  "type": "private|group|camp",
  "teacherId": "æ•™å¸ˆID",
  "teacherName": "æ•™å¸ˆå§“å",
  "description": "è¯¾ç¨‹æè¿°",
  "maxStudents": 8,
  "minStudents": 2,
  "price": 1,
  "duration": 60,
  "status": "active",
  "createTime": "2025-01-01T00:00:00.000Z",
  "updateTime": "2025-01-01T00:00:00.000Z",
  "createdBy": "åˆ›å»ºè€…openid"
}
```

#### 2.3 è¯¾ç¨‹å®‰æ’é›†åˆ (courseSchedule)
```json
{
  "_id": "æ—¥ç¨‹ID",
  "courseId": "è¯¾ç¨‹ID",
  "teacherId": "æ•™å¸ˆID",
  "teacherName": "æ•™å¸ˆå§“å",
  "date": "2025-07-08",
  "startTime": "19:15",
  "endTime": "20:15",
  "maxStudents": 8,
  "minStudents": 2,
  "currentStudents": 0,
  "status": "published",
  "createTime": "2025-01-01T00:00:00.000Z",
  "createdBy": "åˆ›å»ºè€…openid"
}
```

#### 2.4 é¢„çº¦è®°å½•é›†åˆ (bookings)
```json
{
  "_id": "é¢„çº¦ID",
  "userId": "ç”¨æˆ·openid",
  "scheduleId": "è¯¾ç¨‹æ—¥ç¨‹ID",
  "courseId": "è¯¾ç¨‹ID",
  "status": "booked|waitlist|cancelled|completed",
  "bookingTime": "2025-01-01T00:00:00.000Z",
  "cancelTime": "å–æ¶ˆæ—¶é—´",
  "creditsUsed": 1,
  "refunded": false,
  "position": 1
}
```

#### 2.5 è¯¾æ—¶è®°å½•é›†åˆ (classRecords)
```json
{
  "_id": "è®°å½•ID",
  "userId": "ç”¨æˆ·openid",
  "scheduleId": "è¯¾ç¨‹æ—¥ç¨‹ID",
  "courseId": "è¯¾ç¨‹ID",
  "attendanceStatus": "attended|absent",
  "attendanceTime": "2025-01-01T00:00:00.000Z",
  "creditsDeducted": 1,
  "recordTime": "2025-01-01T00:00:00.000Z"
}
```

#### 2.6 é€šçŸ¥è®°å½•é›†åˆ (notifications)
```json
{
  "_id": "é€šçŸ¥ID",
  "userId": "ç”¨æˆ·openid",
  "type": "booking_success|class_confirmed|class_reminder|class_cancelled",
  "title": "é€šçŸ¥æ ‡é¢˜",
  "content": "é€šçŸ¥å†…å®¹",
  "scheduleId": "ç›¸å…³è¯¾ç¨‹æ—¥ç¨‹ID",
  "isRead": false,
  "sendTime": "2025-01-01T00:00:00.000Z"
}
```

#### 2.7 ç®¡ç†å‘˜é›†åˆ (admins)
```json
{
  "_id": "ç®¡ç†å‘˜ID",
  "openid": "ç®¡ç†å‘˜openid",
  "nickName": "ç®¡ç†å‘˜æ˜µç§°",
  "role": "admin",
  "status": "active",
  "createTime": "2025-01-01T00:00:00.000Z"
}
```

#### 2.8 æ“ä½œæ—¥å¿—é›†åˆ (adminLogs)
```json
{
  "_id": "æ—¥å¿—ID",
  "adminOpenid": "ç®¡ç†å‘˜openid",
  "targetUserOpenid": "ç›®æ ‡ç”¨æˆ·openid",
  "action": "update_credits",
  "operation": "add|set|deduct",
  "groupCreditsChange": 0,
  "termCreditsChange": 0,
  "reason": "æ“ä½œåŸå› ",
  "originalGroupCredits": 0,
  "originalTermCredits": 0,
  "timestamp": "2025-01-01T00:00:00.000Z"
}
```

### ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®æ•°æ®åº“æƒé™

ä¸ºæ¯ä¸ªé›†åˆè®¾ç½®é€‚å½“çš„æƒé™è§„åˆ™ï¼š

#### 3.1 users é›†åˆæƒé™
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

#### 3.2 courses é›†åˆæƒé™
```json
{
  "read": true,
  "write": false
}
```

#### 3.3 courseSchedule é›†åˆæƒé™
```json
{
  "read": true,
  "write": false
}
```

#### 3.4 bookings é›†åˆæƒé™
```json
{
  "read": "doc.userId == auth.openid",
  "write": "doc.userId == auth.openid"
}
```

#### 3.5 å…¶ä»–é›†åˆæƒé™
æ‰€æœ‰å…¶ä»–é›†åˆè®¾ç½®ä¸ºï¼š
```json
{
  "read": false,
  "write": false
}
```

### ç¬¬å››æ­¥ï¼šéƒ¨ç½²äº‘å‡½æ•°

#### 4.1 äº‘å‡½æ•°åˆ—è¡¨
éœ€è¦éƒ¨ç½²çš„äº‘å‡½æ•°åŒ…æ‹¬ï¼š

**åŸºç¡€äº‘å‡½æ•°ï¼š**
- `login` - ç”¨æˆ·ç™»å½•
- `getUser` - è·å–ç”¨æˆ·ä¿¡æ¯
- `registerUser` - ç”¨æˆ·æ³¨å†Œ
- `getUserCredits` - è·å–ç”¨æˆ·æ¬¡å¡ä½™é¢

**è¯¾ç¨‹ç›¸å…³äº‘å‡½æ•°ï¼š**
- `getDaySchedule` - è·å–æ¯æ—¥è¯¾ç¨‹å®‰æ’
- `bookCourse` - é¢„çº¦è¯¾ç¨‹
- `cancelBooking` - å–æ¶ˆé¢„çº¦
- `getUserBookings` - è·å–ç”¨æˆ·é¢„çº¦è®°å½•
- `getCourses` - è·å–è¯¾ç¨‹åˆ—è¡¨

**é€šçŸ¥ç³»ç»Ÿäº‘å‡½æ•°ï¼š**
- `sendNotification` - å‘é€é€šçŸ¥
- `courseReminder` - è¯¾ç¨‹æé†’ï¼ˆå®šæ—¶å™¨ï¼‰

**ç®¡ç†å‘˜äº‘å‡½æ•°ï¼š**
- `adminAddCourse` - ç®¡ç†å‘˜æ·»åŠ è¯¾ç¨‹
- `adminAddSchedule` - ç®¡ç†å‘˜æ·»åŠ è¯¾ç¨‹å®‰æ’
- `adminUpdateCredits` - ç®¡ç†å‘˜æ›´æ–°ç”¨æˆ·è¯¾æ—¶
- `getAllUsers` - è·å–æ‰€æœ‰ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰

#### 4.2 éƒ¨ç½²æ­¥éª¤

1. **å³é”®ç‚¹å‡»äº‘å‡½æ•°æ–‡ä»¶å¤¹**
   - åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å³é”®ç‚¹å‡» `cloudfunctions` æ–‡ä»¶å¤¹
   - é€‰æ‹©"åŒæ­¥äº‘å‡½æ•°åˆ—è¡¨"

2. **é€ä¸ªéƒ¨ç½²äº‘å‡½æ•°**
   - å³é”®ç‚¹å‡»æ¯ä¸ªäº‘å‡½æ•°æ–‡ä»¶å¤¹ï¼ˆå¦‚ `login`ï¼‰
   - é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
   - ç­‰å¾…éƒ¨ç½²å®Œæˆ

3. **éªŒè¯éƒ¨ç½²**
   - åœ¨äº‘å¼€å‘æ§åˆ¶å°çš„"äº‘å‡½æ•°"é¡µé¢æŸ¥çœ‹
   - ç¡®ä¿æ‰€æœ‰å‡½æ•°çŠ¶æ€ä¸º"éƒ¨ç½²æˆåŠŸ"

#### 4.3 è®¾ç½®å®šæ—¶å™¨

ä¸º `courseReminder` äº‘å‡½æ•°è®¾ç½®å®šæ—¶å™¨ï¼š

1. åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰¾åˆ° `courseReminder` äº‘å‡½æ•°
2. ç‚¹å‡»"å®šæ—¶å™¨"æ ‡ç­¾
3. æ·»åŠ å®šæ—¶å™¨ï¼š
   - åç§°ï¼š`hourly-reminder`
   - è§¦å‘å‘¨æœŸï¼š`0 * * * * * *`ï¼ˆæ¯å°æ—¶è§¦å‘ä¸€æ¬¡ï¼‰
   - å‚æ•°ï¼š`{}`

### ç¬¬äº”æ­¥ï¼šè®¾ç½®ç®¡ç†å‘˜æƒé™

#### 5.1 æ·»åŠ ç®¡ç†å‘˜è®°å½•

åœ¨ `admins` é›†åˆä¸­æ‰‹åŠ¨æ·»åŠ ç®¡ç†å‘˜è®°å½•ï¼š

```json
{
  "openid": "your-admin-openid",
  "nickName": "ç®¡ç†å‘˜å§“å",
  "role": "admin",
  "status": "active",
  "createTime": "2025-01-01T00:00:00.000Z"
}
```

#### 5.2 æ›´æ–°åº”ç”¨é…ç½®

åœ¨ `miniprogram/app.js` ä¸­æ›´æ–°ç®¡ç†å‘˜åˆ—è¡¨ï¼š

```javascript
globalData: {
  userInfo: null,
  openid: null,
  adminList: ['your-admin-openid-here'] // æ›¿æ¢ä¸ºå®é™…çš„ç®¡ç†å‘˜openid
}
```

### ç¬¬å…­æ­¥ï¼šç”³è¯·è®¢é˜…æ¶ˆæ¯æ¨¡æ¿

1. **ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°**
   - è¿›å…¥å°ç¨‹åºåå°
   - æ‰¾åˆ°"è®¢é˜…æ¶ˆæ¯"åŠŸèƒ½

2. **ç”³è¯·æ¶ˆæ¯æ¨¡æ¿**
   éœ€è¦ç”³è¯·ä»¥ä¸‹ç±»å‹çš„æ¶ˆæ¯æ¨¡æ¿ï¼š
   - é¢„çº¦æˆåŠŸé€šçŸ¥
   - è¯¾ç¨‹ç¡®è®¤é€šçŸ¥
   - è¯¾ç¨‹æé†’é€šçŸ¥
   - è¯¾ç¨‹å–æ¶ˆé€šçŸ¥

3. **æ›´æ–°æ¨¡æ¿ID**
   åœ¨ `sendNotification` äº‘å‡½æ•°ä¸­æ›´æ–°æ¨¡æ¿IDï¼š
   ```javascript
   const templateMapping = {
     'booking_success': 'your-template-id-1',
     'class_confirmed': 'your-template-id-2',
     'class_reminder': 'your-template-id-3',
     'class_cancelled': 'your-template-id-4'
   };
   ```

## âœ… éªŒè¯éƒ¨ç½²

### 7.1 åŸºç¡€åŠŸèƒ½æµ‹è¯•

1. **ç”¨æˆ·æ³¨å†Œç™»å½•**
   - åœ¨ä¸ªäººä¸­å¿ƒç‚¹å‡»"è·å–ç”¨æˆ·ä¿¡æ¯"
   - ç¡®è®¤ç”¨æˆ·ä¿¡æ¯æ­£ç¡®ä¿å­˜

2. **è¯¾ç¨‹é¢„çº¦**
   - ç®¡ç†å‘˜å…ˆæ·»åŠ è¯¾ç¨‹å’Œæ—¥ç¨‹
   - æ™®é€šç”¨æˆ·å°è¯•é¢„çº¦è¯¾ç¨‹

3. **ç®¡ç†å‘˜åŠŸèƒ½**
   - ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
   - æµ‹è¯•è¯¾ç¨‹ç®¡ç†å’Œç”¨æˆ·ç®¡ç†åŠŸèƒ½

### 7.2 å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1ï¼šäº‘å‡½æ•°è°ƒç”¨å¤±è´¥**
- æ£€æŸ¥äº‘ç¯å¢ƒIDæ˜¯å¦æ­£ç¡®
- ç¡®è®¤äº‘å‡½æ•°éƒ¨ç½²æˆåŠŸ
- æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—

**é—®é¢˜2ï¼šæ•°æ®åº“æƒé™é”™è¯¯**
- æ£€æŸ¥æ•°æ®åº“æƒé™è®¾ç½®
- ç¡®è®¤ç”¨æˆ·å·²æ­£ç¡®ç™»å½•

**é—®é¢˜3ï¼šç®¡ç†å‘˜åŠŸèƒ½æ— æ³•ä½¿ç”¨**
- æ£€æŸ¥ç®¡ç†å‘˜openidæ˜¯å¦æ­£ç¡®
- ç¡®è®¤ `admins` é›†åˆä¸­æœ‰å¯¹åº”è®°å½•

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“ç´¢å¼•**
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
   - å¦‚ï¼š`openid`ã€`scheduleId`ã€`date` ç­‰

2. **äº‘å‡½æ•°ä¼˜åŒ–**
   - åˆç†è®¾ç½®äº‘å‡½æ•°è¶…æ—¶æ—¶é—´
   - ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

3. **ç¼“å­˜ç­–ç•¥**
   - å¯¹ä¸ç»å¸¸å˜åŒ–çš„æ•°æ®ä½¿ç”¨æœ¬åœ°ç¼“å­˜
   - å¦‚è¯¾ç¨‹åˆ—è¡¨ã€æ•™å¸ˆåˆ—è¡¨ç­‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [äº‘æ•°æ®åº“ä½¿ç”¨æŒ‡å—](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database.html)
- [äº‘å‡½æ•°å¼€å‘æŒ‡å—](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions.html)

## ğŸ’¬ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. å¾®ä¿¡å¼€å‘è€…å·¥å…·æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
2. äº‘å¼€å‘æ§åˆ¶å°çš„äº‘å‡½æ•°æ—¥å¿—
3. æ•°æ®åº“æ“ä½œæ—¥å¿—

---

*éƒ¨ç½²å®Œæˆåï¼Œæ‚¨çš„çº¦è¯¾ç³»ç»Ÿå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼*
