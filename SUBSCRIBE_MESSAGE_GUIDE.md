# 订阅消息配置指南

## 📋 概述

本指南将帮助您完成微信小程序订阅消息的配置，实现用户约课时的4小时提前提醒功能。

## 🏗️ 已实现的功能

### 1. 云函数
- ✅ `sendSubscribeMessage` - 发送微信订阅消息
- ✅ `courseReminder` - 课程提醒定时器（仅4小时提醒，纯微信通知）

### 2. 前端功能
- ✅ 预约成功后自动询问用户是否开启提醒
- ✅ 调用 `wx.requestSubscribeMessage` 请求用户授权
- ✅ 处理不同的授权状态（accept, acceptWithAudio, acceptWithAlert）

### 3. 提醒时机
- ✅ **4小时提醒**：课程开始前4小时发送微信订阅消息
- ✅ **纯微信通知**：只使用微信原生订阅消息推送，不发送小程序内通知
- ✅ **私教支持**：支持团课和私教课程提醒

## 🛠️ 配置步骤

### 步骤1: 申请订阅消息模板

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入您的小程序后台
3. 左侧菜单：功能 → 订阅消息
4. 点击"公共模板库"
5. 搜索适合的模板，推荐关键词：
   - "课程提醒"
   - "活动提醒" 
   - "服务提醒"
   - "预约提醒"

### 步骤2: 推荐的模板格式

建议申请包含以下字段的模板：

**4小时提醒模板格式：**
```
课程名称：{{thing1.DATA}}  (团课名称或"私教课程")
上课时间：{{time2.DATA}}
瑜伽老师：{{thing4.DATA}}
温馨提示：{{thing5.DATA}}  ("您的课程还有4h开始，请准时到场。")
```

**当前使用的模板ID：** `r79vVscc3dDWZA7x98g-5eDEmwaAkFTbknr5x6v_2iY`

### 步骤3: 获取模板ID

1. 申请通过后，在"我的模板"中查看
2. 复制模板ID（形如：`BEwX0BOT3MqK3Uc5oTU3CGBqzjpndk2jzUf7VfExd8`）

### 步骤4: 更新代码中的模板ID

需要在以下文件中替换模板ID：

#### 模板ID已配置完成 ✅

当前系统已配置：
- **4小时提醒模板ID**: `r79vVscc3dDWZA7x98g-5eDEmwaAkFTbknr5x6v_2iY`
- **支持课程类型**: 团课和私教课程
- **提醒时机**: 仅开课前4小时（已取消1小时提醒）

### 步骤5: 部署云函数

确保以下云函数已部署：

```bash
# 部署发送订阅消息云函数
wx-server-sdk deploy sendSubscribeMessage

# 更新课程提醒云函数
wx-server-sdk deploy courseReminder
```

## 📱 用户体验流程

### 1. 用户预约课程
- 用户在课程页面选择课程
- 点击预约并确认

### 2. 订阅消息授权
- 预约成功后，系统询问："是否开启课程提醒通知？"
- 用户选择"开启提醒"
- 弹出微信原生订阅消息授权弹窗
- 用户可以选择：
  - ✅ 总是接收
  - ✅ 总是接收（含语音提醒）
  - ✅ 总是接收（含横幅提醒）
  - ❌ 拒绝

### 3. 自动提醒
- **4小时前**：发送课程提醒 "您的课程还有4h开始，请准时到场。"
- **支持课程类型**：团课显示具体课程名称，私教统一显示"私教课程"

## 🔧 测试方法

### 1. 测试订阅消息授权
```javascript
// 在小程序中调试
wx.requestSubscribeMessage({
  tmplIds: ['YOUR_TEMPLATE_ID'],
  success: (res) => {
    console.log('授权结果:', res);
  }
});
```

### 2. 测试云函数发送
在云开发控制台测试 `sendSubscribeMessage`：

```json
{
  "openid": "用户的openid",
  "templateId": "YOUR_TEMPLATE_ID",
  "messageType": "test",
  "data": {
    "thing1": { "value": "测试课程" },
    "time2": { "value": "2024-01-15 19:00" },
    "thing3": { "value": "张老师" },
    "thing4": { "value": "这是一条测试提醒" }
  }
}
```

### 3. 测试定时提醒
手动调用 `courseReminder` 云函数查看日志输出。

## ⚠️ 注意事项

### 1. 订阅消息限制
- 每个用户每个模板只能授权一次
- 用户拒绝后需要删除小程序重新授权
- 一次授权只能发送一条消息

### 2. 模板字段限制
- `thing` 类型：20个汉字以内
- `time` 类型：固定格式 "YYYY-MM-DD HH:mm"
- `phrase` 类型：5个汉字以内

### 3. 发送时机
- 只有在用户授权后才能发送
- 建议在关键操作后请求授权（如预约成功）
- 避免频繁弹出授权弹窗

## 🚀 优化建议

### 1. 增加更多模板
可以申请更多类型的模板：
- 预约成功通知
- 课程取消通知
- 等位转正通知
- 课时不足提醒

### 2. 个性化提醒时间
根据课程类型设置不同的提醒时间：
- 私教课：提前3小时和30分钟
- 团课：提前4小时和1小时
- 工作坊：提前1天和4小时

### 3. 智能提醒内容
根据用户历史行为优化提醒内容：
- 新用户：详细的到店指南
- 老用户：简洁的课程信息
- VIP用户：专属服务提醒

## 📞 技术支持

如遇到问题，请检查：
1. 模板ID是否正确
2. 云函数是否部署成功
3. 用户是否已授权订阅消息
4. 消息内容是否符合模板格式

---

**配置完成后，用户就可以享受到及时的课程提醒服务，大大提升到课率和用户满意度！** 🧘‍♀️✨
